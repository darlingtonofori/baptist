{% extends "base.html" %}

{% block content %}
<div class="forum-container">
    {% if current_user.is_authenticated %}
    <div class="post-form">
        <h3>Create New Thread</h3>
        <form id="create-post" enctype="multipart/form-data">
            <input type="text" name="title" placeholder="Title (optional)">
            <textarea name="content" placeholder="Your message..." required></textarea>
            <div class="file-upload">
                <label for="post-image">Upload Image (PNG, JPG, GIF):</label>
                <input type="file" id="post-image" name="image" accept="image/png, image/jpeg, image/gif">
            </div>
            <button type="submit">Post</button>
            <div id="post-error" class="error-message"></div>
        </form>
    </div>
    {% endif %}
    
    <div class="posts-list" id="posts-list">
        {% for post in posts %}
        <div class="post" data-post-id="{{ post.id }}">
            <div class="post-header">
                <span class="post-author">{{ post.author.username }}</span>
                <span class="post-date">{{ post.created_at.strftime('%Y-%m-%d %H:%M') }}</span>
                {% if current_user.is_admin or current_user.id == post.user_id %}
                <button class="delete-post" data-post-id="{{ post.id }}">√ó</button>
                {% endif %}
            </div>
            {% if post.title %}
            <h3 class="post-title">{{ post.title }}</h3>
            {% endif %}
            <div class="post-content">{{ post.content }}</div>
            {% if post.image %}
            <div class="post-image">
                <img src="{{ url_for('static', filename='images/' + post.image) }}" alt="Post image">
            </div>
            {% endif %}
            <div class="post-footer">
                <span class="post-views">üëÅÔ∏è {{ post.views }} views</span>
                <span class="post-comments-toggle">üí¨ {{ post.comments|length }} comments</span>
            </div>
            <div class="comments-section" style="display: none;">
                {% for comment in post.comments %}
                <div class="comment">
                    <div class="comment-header">
                        <span class="comment-author">{{ comment.author.username }}</span>
                        <span class="comment-date">{{ comment.created_at.strftime('%Y-%m-%d %H:%M') }}</span>
                    </div>
                    <div class="comment-content">{{ comment.content }}</div>
                </div>
                {% endfor %}
                {% if current_user.is_authenticated %}
                <form class="add-comment" data-post-id="{{ post.id }}">
                    <textarea placeholder="Add a comment..." required></textarea>
                    <button type="submit">Comment</button>
                </form>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Real-time post updates
    const eventSource = new EventSource('/stream');
    const postsList = document.getElementById('posts-list');
    
    eventSource.onmessage = function(e) {
        const post = JSON.parse(e.data);
        
        // Create new post element
        const postElement = document.createElement('div');
        postElement.className = 'post';
        postElement.dataset.postId = post.id;
        postElement.innerHTML = `
            <div class="post-header">
                <span class="post-author">${post.username}</span>
                <span class="post-date">${post.created_at}</span>
             {% if current_user.is_authenticated and (current_user.is_admin or current_user.id == post.user_id) %}
<button class="delete-post" data-post-id="{{ post.id }}">√ó</button>
{% endif %}
            </div>
            ${post.title ? `<h3 class="post-title">${post.title}</h3>` : ''}
            <div class="post-content">${post.content}</div>
            ${post.image ? `
            <div class="post-image">
                <img src="/static/images/${post.image}" alt="Post image">
            </div>` : ''}
            <div class="post-footer">
                <span class="post-views">üëÅÔ∏è ${post.views} views</span>
                <span class="post-comments-toggle">üí¨ 0 comments</span>
            </div>
            <div class="comments-section" style="display: none;">
                {% if current_user.is_authenticated %}
                <form class="add-comment" data-post-id="${post.id}">
                    <textarea placeholder="Add a comment..." required></textarea>
                    <button type="submit">Comment</button>
                </form>
                {% endif %}
            </div>
        `;
        
        // Add click handlers for the new post
        setupPostInteractions(postElement);
        
        // Insert at the top of the posts list
        postsList.insertBefore(postElement, postsList.firstChild);
    };

    // Post form submission
    const postForm = document.getElementById('create-post');
    if (postForm) {
        postForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const errorElement = document.getElementById('post-error');
            errorElement.textContent = '';
            
            fetch('/post', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    this.reset();
                } else {
                    errorElement.textContent = data.error || 'Error creating post';
                }
            })
            .catch(error => {
                errorElement.textContent = 'Error creating post';
            });
        });
    }

    // Setup post interactions (comments, delete, etc.)
    function setupPostInteractions(postElement) {
        // Toggle comments
        const toggleBtn = postElement.querySelector('.post-comments-toggle');
        if (toggleBtn) {
            toggleBtn.addEventListener('click', function() {
                const commentsSection = postElement.querySelector('.comments-section');
                commentsSection.style.display = commentsSection.style.display === 'none' ? 'block' : 'none';
            });
        }

        // Add comment
        const commentForm = postElement.querySelector('.add-comment');
        if (commentForm) {
            commentForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const postId = this.dataset.postId;
                const content = this.querySelector('textarea').value;
                
                fetch('/comment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `post_id=${postId}&content=${encodeURIComponent(content)}`
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        this.querySelector('textarea').value = '';
                        // You could add the new comment to the DOM here
                    }
                });
            });
        }

        // Delete post
        const deleteBtn = postElement.querySelector('.delete-post');
        if (deleteBtn) {
            deleteBtn.addEventListener('click', function() {
                const postId = this.dataset.postId;
                if (confirm('Are you sure you want to delete this post?')) {
                    fetch(`/delete_post/${postId}`, {
                        method: 'POST'
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            postElement.remove();
                        }
                    });
                }
            });
        }
    }

    // Initialize interactions for existing posts
    document.querySelectorAll('.post').forEach(post => {
        setupPostInteractions(post);
    });
});
</script>
{% endblock %}
